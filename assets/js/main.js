function e(e,t,n=document){return n.addEventListener(e,t)}function t(e,t,n=document){return n.removeEventListener(e,t)}function n(e,t=document,n=!1){return n?t.querySelectorAll(e):t.querySelector(e)}function o(e,t,n="beforeend"){let o="lastElementChild";switch(n){case"beforebegin":case"beforebegin":o="previousElementSibling";break;case"afterbegin":o="firstElementChild"}return t.insertAdjacentHTML(n,e),t[o]}function a(e){console.log("message",e);const t=window[Symbol.for("diviDesignNotesAPI")].messageElement;t.innerHTML="";const n=o(`<div>${e}</div>`,t);document.body.appendChild(t);n.animate([{opacity:0,transform:"translateX(100%)"},{opacity:1,transform:"translateX(0)",offset:.1},{opacity:1,transform:"translateX(0)",offset:.9},{opacity:0,transform:"translateX(100%)"}],{duration:4e3,easing:"ease",fill:"forwards"}).onfinish=()=>t.remove()}function s(t,n){const o={element:n,marker:t,active:!1,textArea:null,is_ajaxing:!1,mensions:[],openClose(){o.active?o.close():o.open()},open(){window[Symbol.for("diviDesignNotesAPI")].closeDropdowns(),o.element.classList.add("open"),o.active=!0,o.setPosition()},close(){o.element.classList.remove("open"),o.active=!1},checkMensions(e){o.mensions=[];let t=e;return window[Symbol.for("diviDesignNotesAPI")].data.users.forEach((n=>{e.includes(`@${n.display_name}`)&&(t=t.replace(`@${n.display_name}`,`<span>@${n.display_name}</span>`),!o.mensions.indexOf(n.user_email)+1&&o.mensions.push(n.user_email))})),t},setPosition(){if(!o.active)return;const e=o.marker.element.getBoundingClientRect(),t=e.x<175?1:0,n=innerWidth-e.right<175?3:0,a=innerHeight-e.bottom<200?5:0;let s="";if(a||n||t)switch(a+t+n){case 1:case 4:s=`translateX(${-e.x}px)`;break;case 3:s=`translateX(-${350-(innerWidth-e.right)}px)`;break;case 5:s="translate(-50%,-100%) translate(15px,-40px)";break;case 6:s=`translate(${-e.x}px,-100%) translateY(-40px)`;break;case 8:s=`translate(-${350-(innerWidth-e.right)}px,-100%) translateY(-40px)`;break;case 9:s="translate(0,-100%) translateY(-40px)"}o.element.style.top=`${e.bottom}px`,o.element.style.left=`${e.x}px`,o.element.style.transform=s,o.element.style.maxHeight=a?"":innerHeight-e.bottom+"px"},clicked(e){if(e.target.dataset.action&&!o.is_ajaxing){if(o.ajaxing(!0),"cancel"===e.target.dataset.action)return o.close(),void o.ajaxing(!1);"resolve"!==e.target.dataset.action?"restore"!==e.target.dataset.action?"post"!==e.target.dataset.action?"delete"!==e.target.dataset.action||o.delete():o.post():o.restore():o.resolve()}},resolve(){o.ajaxing(!0);const e=new FormData;e.append("type","resolve"),e.append("id",o.marker.id),window[Symbol.for("diviDesignNotesAPI")].ajax(e).then((e=>{if(e.ok)return e.json()})).then((e=>{o.marker.element.classList.add("resolved"),o.element.classList.add("resolved"),a(`Note: ${o.marker.id} has been set to status: "Resolved"`),o.ajaxing(!1)})).catch((e=>{a("Something went wrong try refreshing the page."),o.ajaxing(!1)}))},restore(){o.ajaxing(!0);const e=new FormData,t=o.marker.id;e.append("type","restore"),e.append("id",t),e.append("status","resolved"),window[Symbol.for("diviDesignNotesAPI")].ajax(e).then((e=>{if(e.ok)return e.json()})).then((e=>{o.marker.element.classList.remove("resolved"),o.element.classList.remove("resolved"),o.ajaxing(!1),a(`Note: ${t} has been set to status: "Active"`)})).catch((e=>{o.ajaxing(!1)}))},post(){if(!o.textArea.value.trim())return o.textArea.value="",void o.ajaxing(!1);o.ajaxing(!0);const e=new FormData,t=o.checkMensions(o.textArea.value);o.mensions.length&&e.append("mensions",o.mensions.join(",")),e.append("type","post"),e.append("parent_id",o.marker.id),e.append("content",t.trim()),e.append("post_id",window[Symbol.for("diviDesignNotesAPI")].data.post_id),e.append("href",window[Symbol.for("diviDesignNotesAPI")].data.href),e.append("title",window[Symbol.for("diviDesignNotesAPI")].data.title),window[Symbol.for("diviDesignNotesAPI")].ajax(e).then((e=>{if(e.ok)return e.json()})).then((e=>{if(e.success){o.element.querySelector(".design_note_dropdown_body").insertAdjacentHTML("beforeend",e.html),o.textArea.value="",a("Your reply has been posted.")}o.ajaxing(!1)})).catch((e=>{a("Something went wrong try refreshing the page."),o.ajaxing(!1)}))},delete(){o.ajaxing(!0);const e=new FormData,t=o.marker.id;e.append("type","trash"),e.append("id",t),window[Symbol.for("diviDesignNotesAPI")].ajax(e).then((e=>{if(e.ok)return e.json()})).then((e=>{e.trashed?(window[Symbol.for("diviDesignNotesAPI")].delete(o.marker),a(`Note: ${t} has been moved to Trash`)):(a("Something went wrong try refreshing the page."),o.ajaxing(!1))})).catch((e=>{a("Something went wrong try refreshing the page."),o.ajaxing(!1)}))},ajaxing(e=null){if(null===e)return o.is_ajaxing;e&&(o.element.classList.add("ajaxing"),o.is_ajaxing=!0),e||(o.element.classList.remove("ajaxing"),o.is_ajaxing=!1)},init(){o.textArea=o.element.querySelector("textarea"),document.body.appendChild(o.element),e("click",o.clicked,o.element)}};return o.init(),o}function i(t){const o={element:t,id:t.id.split("-")[1],data:JSON.parse(t.dataset.params),relatedElement:null,relativeToElement:!1,dropDown:null,position:{x:0,y:0},getRelativity:()=>(o.relativeToElement=["relative","absolute","fixed"].includes(getComputedStyle(o.relatedElement).position),o.relativeToElement),setRelPosition(){o.element.style.position="absolute",o.element.style.top=o.position.y/o.relatedElement.offsetHeight*100+"%",o.element.style.left=o.position.x/o.relatedElement.offsetWidth*100+"%",o.element.style.transform="translate(-20px,-40px)"},setFixPosition(){const e=o.relatedElement.getBoundingClientRect();o.element.style.transform=`translate3d(${o.position.x+e.x}px,${o.position.y+e.y}px,0)`},setPosition(){o.relativeToElement||o.setFixPosition()},openClose(e){o.dropDown.openClose(o.dropDown)},init(){try{o.relatedElement=n(o.data.el)}catch{}return o.relatedElement||(o.relatedElement=n("#page-container")),o.position=o.data.pos,o.getRelativity()?(o.setRelPosition(),o.relatedElement.appendChild(o.element)):(o.element.style.position="fixed",o.setFixPosition(),document.body.appendChild(o.element)),o.dropDown=s(o,n(`#notedropdown-${o.id}`)),e("click",o.openClose,o.element),o}};return o}function r(t,n){const o={element:n,marker:t,active:!1,textArea:null,is_ajaxing:!1,mensions:[],openClose:()=>{o.active?o.close():o.open()},open:()=>{window[Symbol.for("diviDesignNotesAPI")].closeDropdowns(),o.element.classList.add("open"),o.active=!0,o.setPosition()},close:()=>{o.element.classList.remove("open"),o.active=!1},checkMensions(e){o.mensions=[];let t=e;return window[Symbol.for("diviDesignNotesAPI")].data.users.forEach((n=>{e.includes(`@${n.display_name}`)&&(t=t.replace(`@${n.display_name}`,`<span>@${n.display_name}</span>`),!o.mensions.indexOf(n.user_email)+1&&o.mensions.push(n.user_email))})),t},setPosition(){if(!o.active)return;const e=o.marker.element.getBoundingClientRect(),t=e.x<175?1:0,n=innerWidth-e.right<175?3:0,a=innerHeight-e.bottom<200?5:0;let s="";if(a||n||t)switch(a+t+n){case 1:case 4:s=`translateX(${-e.x}px)`;break;case 3:s=`translateX(-${350-(innerWidth-e.right)}px)`;break;case 5:s="translate(-50%,-100%) translate(15px,-40px)";break;case 6:s=`translate(${-e.x}px,-100%) translateY(-40px)`;break;case 8:s=`translate(-${350-(innerWidth-e.right)}px,-100%) translateY(-40px)`;break;case 9:s="translate(0,-100%) translateY(-40px)"}o.element.style.top=`${e.bottom}px`,o.element.style.left=`${e.x}px`,o.element.style.transform=s,o.element.style.maxHeight=a?"":innerHeight-e.bottom+"px"},clear(){o.textArea.value=""},clicked:e=>{e.target.dataset.action&&!o.is_ajaxing&&(o.ajaxing(!0),"cancel"===e.target.dataset.action&&(o.clear(),o.marker.reset(),o.ajaxing(!1)),"create"!==e.target.dataset.action||o.create())},create:()=>{if(!o.textArea.value.trim())return o.textArea.value="",void o.ajaxing(!1);const e=new FormData,t=o.checkMensions(o.textArea.value);o.mensions.length&&e.append("mensions",o.mensions.join(",")),e.append("type","create"),e.append("x",o.marker.position.x),e.append("y",o.marker.position.y),e.append("el",o.marker.getElSelector()),e.append("content",t.trim()),e.append("post_id",window[Symbol.for("diviDesignNotesAPI")].data.post_id),e.append("href",window[Symbol.for("diviDesignNotesAPI")].data.href),e.append("title",window[Symbol.for("diviDesignNotesAPI")].data.title),window[Symbol.for("diviDesignNotesAPI")].ajax(e).then((e=>{if(e.ok)return e.json()})).then((e=>{e.success&&(o.clear(),o.marker.reset(),window[Symbol.for("diviDesignNotesAPI")].createNote(e.html),a("New note has been created.")),o.ajaxing(!1)})).catch((e=>{a("Something went wrong try refreshing the page."),o.ajaxing(!1)}))},ajaxing(e=null){if(null===e)return o.is_ajaxing;e&&(o.element.classList.add("ajaxing"),o.is_ajaxing=!0),e||(o.element.classList.remove("ajaxing"),o.is_ajaxing=!1)},init(){o.textArea=o.element.querySelector("textarea"),document.body.appendChild(o.element),e("click",o.clicked,o.element)}};return o.init(),o}function l(t){const o={element:t,relatedElement:null,relativeToElement:!1,dropDown:null,active:!1,position:{x:0,y:0},getElSelector:()=>o.relatedElement.id?"#"+o.relatedElement.id:o.relatedElement.classList?"."+Array.from(o.relatedElement.classList).join("."):"#page-container",pinOnPage(e,t){o.position=t,o.relatedElement=e,o.active=!0,o.element.classList.remove("active"),o.getRelativity()?o.setRelPosition():o.setFixPosition(),o.openClose()},setPosition(){o.active&&(o.relativeToElement||o.setFixPosition())},getRelativity:()=>(o.relativeToElement=["relative","absolute","fixed"].includes(getComputedStyle(o.relatedElement).position),o.relativeToElement),setRelPosition(){o.relatedElement.appendChild(o.element),o.element.style.position="absolute",o.element.style.top=o.position.y/o.relatedElement.offsetHeight*100+"%",o.element.style.left=o.position.x/o.relatedElement.offsetWidth*100+"%",o.element.style.transform="translate(-20px,-40px)"},setFixPosition(){const e=o.relatedElement.getBoundingClientRect();o.element.style.transform=`translate3d(${o.position.x+e.x}px,${o.position.y+e.y}px,0)`},openClose(){o.dropDown.openClose()},activate(e){o.element.classList.add("active"),e.appendChild(o.element)},reset(){o.relatedElement=null,o.active=!1,o.dropDown.close(),o.element.style="",o.element.remove()},init:()=>(o.dropDown=r(o,n("#shadowdropdown")),e("click",o.openClose,o.element),o)};return o}function d(o){const a={pageContainer:o,element:n("#divi_design_notes_menu"),moveButton:null,toggleButton:null,visibleNotesByStatus:{resolved_notes:!0,active_notes:!0},move(e){a.element.style.transform=`translate3d(${e.clientX}px,${e.clientY}px,0)`},stopMove(e){t("mousemove",a.move),t("mouseup",a.stopMove),t("mouseleave",a.stopMove,a.element),"mouseleave"===e.type&&(a.element.style.transform="")},clicked(e){if(!e.target.dataset.action)return;const t=e.target.dataset.action;"toggle"===t&&a.element.classList.toggle("open"),"new"===t&&window[Symbol.for("diviDesignNotesAPI")].buttonClicked(e)},input(e){"resolved_notes"===e.target.id&&(e.target.checked?(a.visibleNotesByStatus.resolved_notes=!0,document.body.classList.remove("hide-resolved")):(a.visibleNotesByStatus.resolved_notes=!1,document.body.classList.add("hide-resolved"))),"active_notes"===e.target.id&&(e.target.checked?(a.visibleNotesByStatus.active_notes=!0,document.body.classList.remove("hide-active")):(a.visibleNotesByStatus.active_notes=!1,document.body.classList.add("hide-active"))),a.cacheNotesVisability()},cacheNotesVisability(){localStorage.setItem("visibleNotesByStatus",JSON.stringify(a.visibleNotesByStatus))},checkNotesVisability(){const e=localStorage.getItem("visibleNotesByStatus");e&&(a.visibleNotesByStatus=JSON.parse(e))},initiateVisibleNotes(){a.visibleNotesByStatus.resolved_notes?(document.body.classList.remove("hide-resolved"),n("#resolved_notes",a.element).checked=!0):(document.body.classList.add("hide-resolved"),n("#resolved_notes",a.element).checked=!1),a.visibleNotesByStatus.active_notes?(document.body.classList.remove("hide-active"),n("#active_notes",a.element).checked=!0):(document.body.classList.add("hide-active"),n("#active_notes",a.element).checked=!1)},init(){a.moveButton=n('span[data-action="move"]'),a.addButton=n('span[data-action="toggle"]'),a.checkNotesVisability(),a.initiateVisibleNotes(),e("mousedown",(()=>{e("mousemove",a.move),e("mouseup",a.stopMove),e("mouseleave",a.stopMove,a.element)}),a.moveButton),e("click",a.clicked,a.element),e("input",a.input,a.element)}};return a}function m(a,s){const r={button:n("#wp-admin-bar-design_notes"),pageContainer:n("#page-container"),templatesContainer:n("#design_notes_template"),data:JSON.parse(n("#divi_design_notes_json").textContent),notes:[],menu:null,hoveredElement:!1,user:"",markerActive:!1,shadowMarker:null,timeout:0,currenMatch:null,inputTarget:null,caret:null,usersNode:document.createElement("ul"),messageElement:null,buttonClicked:e=>(e.preventDefault(),r.markerActive?r.stopMarker():r.startMarker(),r),startMarker(){r.closeDropdowns(),r.shadowMarker.reset(),r.shadowMarker.activate(r.pageContainer),e("mousemove",r.followMarker,r.pageContainer),r.markerActive=!0,document.body.classList.add("marker-active"),e("click",r.markerClicked,r.pageContainer)},stopMarker(){t("mousemove",r.followMarker,r.pageContainer),r.shadowMarker.element.remove(),r.markerActive=!1,document.body.classList.remove("marker-active"),t("click",r.markerClicked,r.pageContainer),r.hoveredElement&&(r.hoveredElement.style.outline="")},followMarker(e){let t=e.target.matches(".et_pb_module")?e.target:e.target.closest(".et_pb_module,.et_pb_row,.et_pb_section,header,#page-container");t?t!==r.hoveredElement&&(r.hoveredElement&&(r.hoveredElement.style.outline=""),r.hoveredElement=t,r.hoveredElement.style.outline="3px solid blue"):r.hoveredElement&&(r.hoveredElement.style.outline="",r.hoveredElement=!1),r.shadowMarker.element.style.transform=`translate3d(${e.clientX}px,${e.clientY}px,0)`},markerClicked(e){e.preventDefault(),t("mousemove",r.followMarker,r.pageContainer),t("click",r.markerClicked,r.pageContainer);const n=r.hoveredElement.getBoundingClientRect(),o={x:e.x-n.x,y:e.y-n.y};r.shadowMarker.pinOnPage(r.hoveredElement,o),r.markerActive=!1,document.body.classList.remove("marker-active"),r.hoveredElement&&(r.hoveredElement.style.outline="")},createNote(e){const t=i(o(e,r.templatesContainer,"afterbegin")).init();r.notes.push(t),t.openClose()},inputHandler(e){if(e.target.matches(".design_note_textarea")){const t=r.inputTarget=e.target,n=t.value.substring(0,t.selectionStart),o=n.match(/@(?<text>[a-z]{0,3})$/i);if(o)if(r.textToCaret=n,r.currenMatch=o,t.parentElement.appendChild(r.usersNode),o.groups.text){const e=r.data.users.filter((e=>e.display_name.toLowerCase().includes(o.groups.text.toLowerCase())));r.usersNode.innerHTML=r.usersListItems(e)}else r.usersNode.innerHTML=r.usersListItems(r.data.users);else r.usersNode.remove()}},closeDropdowns(){r.notes.forEach((e=>{e.dropDown.close()})),r.shadowMarker.dropDown.close()},chooseUser(e){const t=e.target,n=r.inputTarget,o=new RegExp(`${r.currenMatch[0]}$`,"g"),a=r.textToCaret.replace(o,` @${t.dataset.userName} `);n.value=n.value.replace(r.textToCaret,a),n.focus(),n.setSelectionRange(n.value.length+1,n.value.length+1),r.usersNode.remove()},setPositions(){r.notes.forEach((e=>{e.setPosition(),e.dropDown.setPosition()})),r.shadowMarker.setPosition(),r.shadowMarker.dropDown.setPosition()},maybeSetTimeout(e){r.timeout&&clearTimeout(r.timeout),r.timeout=setTimeout((()=>{r.setPositions(),r.timeout=0}),100)},ajax:e=>(e.append("action","divi_design_notes_ajax"),e.append("diviDesignNotesNonce",r.data.nonce),fetch(r.data.ajaxurl,{method:"POST",body:e})),setMarkers(){n("[id^=notemarker]",r.templatesContainer,!0).forEach((e=>{r.notes.push(i(e).init())}))},delete(e){e.dropDown.element.remove(),e.element.remove(),r.notes.splice(r.notes.indexOf(e),1)},usersListItems:e=>html=e.map((e=>`<li data-user-name="${e.display_name}">${e.display_name}<span>${e.user_email}</span></li>`)).join(""),init(){if(r.markerActive&&r.stopMarker(),r.menu)return void(r.notes.length&&r.setPositions());if(!r.pageContainer)return void console.warn("No #page-container element on the page!");r.messageElement||(r.messageElement=document.createElement("div"),r.messageElement.id="divi_design_notes_message"),r.menu=d(r.pageContainer),r.menu.init(),r.usersNode.id="design_notes_user_list",r.usersNode.innerHTML=r.usersListItems(r.data.users);n("[id^=notemarker]",r.templatesContainer,!0).forEach((e=>{r.notes.push(i(e).init())}));const t=n("#shadowmarker",r.templatesContainer);r.shadowMarker=l(t).init(),e("click",r.chooseUser,r.usersNode),e("scroll",r.maybeSetTimeout),e("resize",r.maybeSetTimeout,window),e("input",r.inputHandler),e("transitionend",r.maybeSetTimeout,r.pageContainer)}};return r}window.addEventListener("load",(function(){const t=n("#wp-admin-bar-design_notes");t&&e("click",(function(){document.body.classList.toggle("show_design_notes"),window[Symbol.for("diviDesignNotesAPI")].init()}),t),window[Symbol.for("diviDesignNotesAPI")]=m()}));
//# sourceMappingURL=main.js.map
