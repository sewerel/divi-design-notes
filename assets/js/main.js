function e(e,t,n=document){return n.addEventListener(e,t)}function t(e,t,n=document){return n.removeEventListener(e,t)}function n(e,t=document,n=!1){return n?t.querySelectorAll(e):t.querySelector(e)}function o(e,t,n="beforeend"){let o="lastElementChild";switch(n){case"beforebegin":case"beforebegin":o="previousElementSibling";break;case"afterbegin":o="firstElementChild"}return t.insertAdjacentHTML(n,e),t[o]}function a(t,n){const o={element:n,marker:t,active:!1,textArea:null,is_ajaxing:!1,mensions:[],openClose(){o.active?o.close():o.open()},open(){window[Symbol.for("diviDesignNotesAPI")].closeDropdowns(),o.element.classList.add("open"),o.active=!0,o.setPosition()},close(){o.element.classList.remove("open"),o.active=!1},checkMensions(e){o.mensions=[];let t=e;return window[Symbol.for("diviDesignNotesAPI")].data.users.forEach((n=>{e.includes(`@${n.display_name}`)&&(t=t.replace(`@${n.display_name}`,`<span>@${n.display_name}</span>`),!o.mensions.indexOf(n.user_email)+1&&o.mensions.push(n.user_email)),console.log(o.mensions)})),t},setPosition(){if(!o.active)return;const e=o.marker.element.getBoundingClientRect(),t=e.x<175?1:0,n=innerWidth-e.right<175?3:0,a=innerHeight-e.bottom<200?5:0;let i="";if(a||n||t)switch(a+t+n){case 1:case 4:i=`translateX(-${e.x}px)`;break;case 3:i=`translateX(-${350-(innerWidth-e.right)}px)`;break;case 5:i="translate(-50%,-100%) translate(15px,-40px)";break;case 6:i=`translate(-${e.x}px,-100%) translateY(-40px)`;break;case 8:i=`translate(-${350-(innerWidth-e.right)}px,-100%) translateY(-40px)`;break;case 9:i="translate(0,-100%) translateY(-40px)"}o.element.style.top=`${e.bottom}px`,o.element.style.left=`${e.x}px`,o.element.style.transform=i,o.element.style.maxHeight=a?"":innerHeight-e.bottom+"px"},clicked(e){if(e.target.dataset.action&&!o.is_ajaxing){if(o.ajaxing(!0),"cancel"===e.target.dataset.action)return o.close(),void o.ajaxing(!1);"resolve"!==e.target.dataset.action?"post"!==e.target.dataset.action?"delete"!==e.target.dataset.action||o.delete():o.post():o.resolve()}},resolve(){o.ajaxing(!0);const e=new FormData;e.append("type","resolve"),e.append("id",o.marker.id),window[Symbol.for("diviDesignNotesAPI")].ajax(e).then((e=>{if(e.ok)return e.json()})).then((e=>{console.log(e),o.marker.element.classList.add("resolved"),o.element.classList.add("resolved"),o.ajaxing(!1)})).catch((e=>{o.ajaxing(!1)}))},post(){if(!o.textArea.value.trim())return void(o.textArea.value="");o.ajaxing(!0);const e=new FormData,t=o.checkMensions(o.textArea.value);o.mensions.length&&e.append("mensions",o.mensions.join(",")),e.append("type","post"),e.append("parent_id",o.marker.id),e.append("content",t.trim()),e.append("post_id",window[Symbol.for("diviDesignNotesAPI")].data.post_id),e.append("href",window[Symbol.for("diviDesignNotesAPI")].data.href),e.append("title",window[Symbol.for("diviDesignNotesAPI")].data.title),window[Symbol.for("diviDesignNotesAPI")].ajax(e).then((e=>{if(e.ok)return e.json()})).then((e=>{if(e.success){o.element.querySelector(".design_note_dropdown_body").insertAdjacentHTML("beforeend",e.html),o.textArea.value=""}o.ajaxing(!1)}))},delete(){o.ajaxing(!0);const e=new FormData;e.append("type","delete"),e.append("note_id",o.marker.id),window[Symbol.for("diviDesignNotesAPI")].ajax(e).then((e=>{if(e.ok)return e.json()})).then((e=>{console.log(e),e.parent&&window[Symbol.for("diviDesignNotesAPI")].delete(o.marker)}))},ajaxing(e=null){if(null===e)return o.is_ajaxing;e&&(o.element.classList.add("ajaxing"),o.is_ajaxing=!0),e||(o.element.classList.remove("ajaxing"),o.is_ajaxing=!1)},init(){o.textArea=o.element.querySelector("textarea"),document.body.appendChild(o.element),e("click",o.clicked,o.element)}};return o.init(),o}function i(t){const o={element:t,id:t.id.split("-")[1],data:JSON.parse(t.dataset.params),relatedElement:"null",relativeToElement:!1,dropDown:null,position:{x:0,y:0},getRelativity:function(){return o.relativeToElement=["relative","absolute","fixed"].includes(getComputedStyle(o.relatedElement).position),o.relativeToElement},setRelPosition:function(){o.element.style.position="absolute",o.element.style.top=o.position.y/o.relatedElement.offsetHeight*100+"%",o.element.style.left=o.position.x/o.relatedElement.offsetWidth*100+"%",o.element.style.transform="translate(-15px,-30px)"},setFixPosition:function(){const e=o.relatedElement.getBoundingClientRect();o.element.style.transform=`translate3d(${o.position.x+e.x}px,${o.position.y+e.y}px,0)`},setPosition:function(){o.relativeToElement||o.setFixPosition()},openClose:function(e){o.dropDown.openClose(o.dropDown)},init:function(){return o.relatedElement=o.data.el?n(o.data.el):n("#page-container"),o.position=o.data.pos,o.getRelativity()?(o.setRelPosition(),o.relatedElement.appendChild(o.element)):(o.element.style.position="fixed",o.setFixPosition(),document.body.appendChild(o.element)),o.dropDown=a(o,n(`#notedropdown-${o.id}`)),e("click",o.openClose,o.element),o}};return o}function s(t,n){const o={element:n,marker:t,active:!1,textArea:null,is_ajaxing:!1,mensions:[],openClose:()=>{o.active?o.close():o.open()},open:()=>{window[Symbol.for("diviDesignNotesAPI")].closeDropdowns(),o.element.classList.add("open"),o.active=!0,o.setPosition()},close:()=>{o.element.classList.remove("open"),o.active=!1},checkMensions(e){o.mensions=[];let t=e;return window[Symbol.for("diviDesignNotesAPI")].data.users.forEach((n=>{e.includes(`@${n.display_name}`)&&(t=t.replace(`@${n.display_name}`,`<span>@${n.display_name}</span>`),!o.mensions.indexOf(n.user_email)+1&&o.mensions.push(n.user_email))})),t},setPosition:()=>{if(!o.active)return;const e=o.marker.element.getBoundingClientRect(),t=e.x<175?1:0,n=innerWidth-e.right<175?3:0,a=innerHeight-e.bottom<200?5:0;let i="";if(a||n||t)switch(a+t+n){case 1:case 4:i=`translateX(-${e.x}px)`;break;case 3:i=`translateX(-${350-(innerWidth-e.right)}px)`;break;case 5:i="translate(-50%,-100%) translate(15px,-40px)";break;case 6:i=`translate(-${e.x}px,-100%) translateY(-40px)`;break;case 8:i=`translate(-${350-(innerWidth-e.right)}px,-100%) translateY(-40px)`;break;case 9:i="translate(0,-100%) translateY(-40px)"}o.element.style.top=`${e.bottom}px`,o.element.style.left=`${e.x}px`,o.element.style.transform=i,o.element.style.maxHeight=a?"":innerHeight-e.bottom+"px"},clear(){o.textArea.value=""},clicked:e=>{e.target.dataset.action&&!o.is_ajaxing&&(o.ajaxing(!0),"cancel"===e.target.dataset.action&&(o.clear(),o.marker.reset(),o.ajaxing(!1)),"create"!==e.target.dataset.action||o.create())},create:()=>{if(!o.textArea.value.trim())return o.textArea.value="",void o.ajaxing(!1);const e=new FormData,t=o.checkMensions(o.textArea.value);o.mensions.length&&e.append("mensions",o.mensions.join(",")),e.append("type","create"),e.append("x",o.marker.position.x),e.append("y",o.marker.position.y),e.append("el",o.marker.getElSelector()),e.append("content",t.trim()),e.append("post_id",window[Symbol.for("diviDesignNotesAPI")].data.post_id),e.append("href",window[Symbol.for("diviDesignNotesAPI")].data.href),e.append("title",window[Symbol.for("diviDesignNotesAPI")].data.title),window[Symbol.for("diviDesignNotesAPI")].ajax(e).then((e=>{if(e.ok)return e.json()})).then((e=>{e.success&&(o.clear(),o.marker.reset(),window[Symbol.for("diviDesignNotesAPI")].createNote(e.html)),o.ajaxing(!1)}))},ajaxing(e=null){if(null===e)return o.is_ajaxing;e&&(o.element.classList.add("ajaxing"),o.is_ajaxing=!0),e||(o.element.classList.remove("ajaxing"),o.is_ajaxing=!1)},init(){o.textArea=o.element.querySelector("textarea"),document.body.appendChild(o.element),e("click",o.clicked,o.element)}};return o.init(),o}function r(t){const o={element:t,relatedElement:null,relativeToElement:!1,dropDown:null,active:!1,position:{x:0,y:0},getElSelector:()=>"."+Array.from(o.relatedElement.classList).join("."),pinOnPage(e,t){o.position=t,o.relatedElement=e,o.active=!0,o.element.classList.remove("active"),o.getRelativity()?o.setRelPosition():o.setFixPosition(),o.openClose()},setPosition(){o.active&&(o.relativeToElement||o.setFixPosition())},getRelativity:()=>(o.relativeToElement=["relative","absolute","fixed"].includes(getComputedStyle(o.relatedElement).position),o.relativeToElement),setRelPosition(){o.relatedElement.appendChild(o.element),o.element.style.position="absolute",o.element.style.top=o.position.y/o.relatedElement.offsetHeight*100+"%",o.element.style.left=o.position.x/o.relatedElement.offsetWidth*100+"%",o.element.style.transform="translate(-15px,-30px)"},setFixPosition(){const e=o.relatedElement.getBoundingClientRect();o.element.style.transform=`translate3d(${o.position.x+e.x}px,${o.position.y+e.y}px,0)`},openClose(){o.dropDown.openClose()},activate(e){o.element.classList.add("active"),e.appendChild(o.element)},reset(){o.relatedElement=null,o.active=!1,o.dropDown.close(),o.element.style="",o.element.remove()},init:()=>(o.dropDown=s(o,n("#shadowdropdown")),e("click",o.openClose,o.element),o)};return o}function l(o){const a={pageContainer:o,element:n("#divi_design_notes_menu"),moveButton:null,toggleButton:null,move(e){a.element.style.transform=`translate3d(${e.clientX}px,${e.clientY}px,0)`},stopMove(e){console.log(e.type,e.currentTarget),t("mousemove",a.move),t("mouseup",a.stopMove),t("mouseleave",a.stopMove,a.element),"mouseleave"===e.type&&(a.element.style.transform="")},clicked(e){if(!e.target.dataset.action)return;const t=e.target.dataset.action;console.log(t),"toggle"===t&&a.element.classList.toggle("open"),"new"===t&&window[Symbol.for("diviDesignNotesAPI")].buttonClicked(e)},input(e){"resolved_notes"===e.target.id&&(e.target.checked?document.body.classList.remove("hide-resolved"):document.body.classList.add("hide-resolved")),"active_notes"===e.target.id&&(e.target.checked?document.body.classList.remove("hide-active"):document.body.classList.add("hide-active"))},init(){a.moveButton=n('span[data-action="move"]'),a.addButton=n('span[data-action="toggle"]'),e("mousedown",(()=>{e("mousemove",a.move),e("mouseup",a.stopMove),e("mouseleave",a.stopMove,a.element)}),a.moveButton),e("click",a.clicked,a.element),e("input",a.input,a.element)}};return a}function d(a,s){const d={button:n("#wp-admin-bar-design_notes"),pageContainer:n("#page-container"),templatesContainer:n("#design_notes_template"),data:JSON.parse(n("#divi_design_notes_json").textContent),notes:[],menu:null,hoveredElement:!1,user:"",markerActive:!1,shadowMarker:null,timeout:0,currenMatch:null,inputTarget:null,caret:null,usersNode:document.createElement("ul"),buttonClicked:e=>(e.preventDefault(),d.markerActive?d.stopMarker():d.startMarker(),d),startMarker(){d.closeDropdowns(),d.shadowMarker.reset(),d.shadowMarker.activate(d.pageContainer),e("mousemove",d.followMarker,d.pageContainer),d.markerActive=!0,document.body.classList.add("marker-active"),e("click",d.markerClicked,d.pageContainer)},stopMarker(){t("mousemove",d.followMarker,d.pageContainer),d.shadowMarker.element.remove(),d.markerActive=!1,document.body.classList.remove("marker-active"),t("click",d.markerClicked,d.pageContainer),d.hoveredElement&&(d.hoveredElement.style.outline="")},followMarker(e){let t=e.target.matches(".et_pb_module")?e.target:e.target.closest(".et_pb_module,.et_pb_row,.et_pb_section,header,#page-container");t?t!==d.hoveredElement&&(d.hoveredElement&&(d.hoveredElement.style.outline=""),d.hoveredElement=t,d.hoveredElement.style.outline="3px solid blue"):d.hoveredElement&&(d.hoveredElement.style.outline="",d.hoveredElement=!1),d.shadowMarker.element.style.transform=`translate3d(${e.clientX}px,${e.clientY}px,0)`},markerClicked(e){e.preventDefault(),t("mousemove",d.followMarker,d.pageContainer),t("click",d.markerClicked,d.pageContainer);const n=d.hoveredElement.getBoundingClientRect(),o={x:e.x-n.x,y:e.y-n.y};d.shadowMarker.pinOnPage(d.hoveredElement,o),d.markerActive=!1,document.body.classList.remove("marker-active"),d.hoveredElement&&(d.hoveredElement.style.outline="")},createNote(e){const t=i(o(e,d.templatesContainer,"afterbegin")).init();d.notes.push(t),t.openClose()},inputHandler(e){if(e.target.matches(".design_note_textarea")){const t=d.inputTarget=e.target,n=t.value.substring(0,t.selectionStart).match(/@[a-z]{0,3}$/i);n?(d.currenMatch=n,t.parentElement.appendChild(d.usersNode)):d.usersNode.remove()}},closeDropdowns(){d.notes.forEach((e=>{e.dropDown.close()})),d.shadowMarker.dropDown.close()},chooseUser(e){const t=e.target,n=d.inputTarget,o=new RegExp(`${d.currenMatch}$`,"g");n.value=n.value.replace(o,`@${t.dataset.userName} `),n.focus(),n.setSelectionRange(n.value.length+1,n.value.length+1),d.usersNode.remove()},setPositions(){d.notes.forEach((e=>{e.setPosition(),e.dropDown.setPosition()})),d.shadowMarker.setPosition(),d.shadowMarker.dropDown.setPosition()},maybeSetTimeout(e){d.timeout&&clearTimeout(d.timeout),d.timeout=setTimeout((()=>{d.setPositions(),d.timeout=0}),100)},ajax:e=>(e.append("action","divi_design_notes_ajax"),e.append("diviDesignNotesNonce",d.data.nonce),fetch(d.data.ajaxurl,{method:"POST",body:e})),setMarkers(){n("[id^=notemarker]",d.templatesContainer,!0).forEach((e=>{d.notes.push(i(e).init())}))},delete(e){e.dropDown.element.remove(),e.element.remove(),d.notes.splice(d.notes.indexOf(e),1)},init(){if(d.markerActive&&d.stopMarker(),d.menu)return;d.menu=l(d.pageContainer),d.menu.init(),d.usersNode.id="design_notes_user_list",d.data.users.forEach((e=>{const t=document.createElement("li");t.dataset.userId=e.id,t.dataset.userName=e.display_name,t.textContent=e.display_name,d.usersNode.appendChild(t)}));n("[id^=notemarker]",d.templatesContainer,!0).forEach((e=>{d.notes.push(i(e).init())}));const t=n("#shadowmarker",d.templatesContainer);d.shadowMarker=r(t).init(),e("click",d.chooseUser,d.usersNode),e("scroll",d.maybeSetTimeout),e("resize",d.maybeSetTimeout,window),e("input",d.inputHandler),e("transitionend",d.maybeSetTimeout,d.pageContainer)}};return d}window.addEventListener("load",(function(){e("click",(function(){document.body.classList.toggle("show_design_notes"),window[Symbol.for("diviDesignNotesAPI")].init()}),n("#wp-admin-bar-design_notes")),window[Symbol.for("diviDesignNotesAPI")]=d()}));
//# sourceMappingURL=main.js.map
