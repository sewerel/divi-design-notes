function e(e,t,n=document){return n.addEventListener(e,t)}function t(e,t,n=document){return n.removeEventListener(e,t)}function n(e,t=document,n=!1){return n?t.querySelectorAll(e):t.querySelector(e)}function a(e,t,n="beforeend"){let a="lastElementChild";switch(n){case"beforebegin":case"beforebegin":a="previousElementSibling";break;case"afterbegin":a="firstElementChild"}return t.insertAdjacentHTML(n,e),t[a]}function o(t,n){const a={element:n,marker:t,active:!1,textArea:null,is_ajaxing:!1,mensions:[],openClose(){a.active?a.close():a.open()},open(){window[Symbol.for("diviDesignNotesAPI")].closeDropdowns(),a.element.classList.add("open"),a.active=!0,a.setPosition()},close(){a.element.classList.remove("open"),a.active=!1},checkMensions(e){a.mensions=[];let t=e;return window[Symbol.for("diviDesignNotesAPI")].data.users.forEach((n=>{e.includes(`@${n.display_name}`)&&(t=t.replace(`@${n.display_name}`,`<span>@${n.display_name}</span>`),!a.mensions.indexOf(n.user_email)+1&&a.mensions.push(n.user_email))})),t},setPosition(){if(!a.active)return;const e=a.marker.element.getBoundingClientRect(),t=e.x<175?1:0,n=innerWidth-e.right<175?3:0,o=innerHeight-e.bottom<200?5:0;let i="";if(o||n||t)switch(o+t+n){case 1:case 4:i=`translateX(${-e.x}px)`;break;case 3:i=`translateX(-${350-(innerWidth-e.right)}px)`;break;case 5:i="translate(-50%,-100%) translate(15px,-40px)";break;case 6:i=`translate(${-e.x}px,-100%) translateY(-40px)`;break;case 8:i=`translate(-${350-(innerWidth-e.right)}px,-100%) translateY(-40px)`;break;case 9:i="translate(0,-100%) translateY(-40px)"}a.element.style.top=`${e.bottom}px`,a.element.style.left=`${e.x}px`,a.element.style.transform=i,a.element.style.maxHeight=o?"":innerHeight-e.bottom+"px"},clicked(e){if(e.target.dataset.action&&!a.is_ajaxing){if(a.ajaxing(!0),"cancel"===e.target.dataset.action)return a.close(),void a.ajaxing(!1);"resolve"!==e.target.dataset.action?"post"!==e.target.dataset.action?"delete"!==e.target.dataset.action||a.delete():a.post():a.resolve()}},resolve(){a.ajaxing(!0);const e=new FormData;e.append("type","resolve"),e.append("id",a.marker.id),window[Symbol.for("diviDesignNotesAPI")].ajax(e).then((e=>{if(e.ok)return e.json()})).then((e=>{a.marker.element.classList.add("resolved"),a.element.classList.add("resolved"),a.ajaxing(!1)})).catch((e=>{a.ajaxing(!1)}))},post(){if(!a.textArea.value.trim())return void(a.textArea.value="");a.ajaxing(!0);const e=new FormData,t=a.checkMensions(a.textArea.value);a.mensions.length&&e.append("mensions",a.mensions.join(",")),e.append("type","post"),e.append("parent_id",a.marker.id),e.append("content",t.trim()),e.append("post_id",window[Symbol.for("diviDesignNotesAPI")].data.post_id),e.append("href",window[Symbol.for("diviDesignNotesAPI")].data.href),e.append("title",window[Symbol.for("diviDesignNotesAPI")].data.title),window[Symbol.for("diviDesignNotesAPI")].ajax(e).then((e=>{if(e.ok)return e.json()})).then((e=>{if(e.success){a.element.querySelector(".design_note_dropdown_body").insertAdjacentHTML("beforeend",e.html),a.textArea.value=""}a.ajaxing(!1)})).catch((e=>{a.ajaxing(!1)}))},delete(){a.ajaxing(!0);const e=new FormData;e.append("type","delete"),e.append("note_id",a.marker.id),window[Symbol.for("diviDesignNotesAPI")].ajax(e).then((e=>{if(e.ok)return e.json()})).then((e=>{e.parent?window[Symbol.for("diviDesignNotesAPI")].delete(a.marker):a.ajaxing(!1)})).catch((e=>{a.ajaxing(!1)}))},ajaxing(e=null){if(null===e)return a.is_ajaxing;e&&(a.element.classList.add("ajaxing"),a.is_ajaxing=!0),e||(a.element.classList.remove("ajaxing"),a.is_ajaxing=!1)},init(){a.textArea=a.element.querySelector("textarea"),document.body.appendChild(a.element),e("click",a.clicked,a.element)}};return a.init(),a}function i(t){const a={element:t,id:t.id.split("-")[1],data:JSON.parse(t.dataset.params),relatedElement:null,relativeToElement:!1,dropDown:null,position:{x:0,y:0},getRelativity:()=>(a.relativeToElement=["relative","absolute","fixed"].includes(getComputedStyle(a.relatedElement).position),a.relativeToElement),setRelPosition(){a.element.style.position="absolute",a.element.style.top=a.position.y/a.relatedElement.offsetHeight*100+"%",a.element.style.left=a.position.x/a.relatedElement.offsetWidth*100+"%",a.element.style.transform="translate(-20px,-40px)"},setFixPosition(){const e=a.relatedElement.getBoundingClientRect();a.element.style.transform=`translate3d(${a.position.x+e.x}px,${a.position.y+e.y}px,0)`},setPosition(){a.relativeToElement||a.setFixPosition()},openClose(e){a.dropDown.openClose(a.dropDown)},init(){try{a.relatedElement=n(a.data.el)}catch{}return a.relatedElement||(a.relatedElement=n("#page-container")),a.position=a.data.pos,a.getRelativity()?(a.setRelPosition(),a.relatedElement.appendChild(a.element)):(a.element.style.position="fixed",a.setFixPosition(),document.body.appendChild(a.element)),a.dropDown=o(a,n(`#notedropdown-${a.id}`)),e("click",a.openClose,a.element),a}};return a}function s(t,n){const a={element:n,marker:t,active:!1,textArea:null,is_ajaxing:!1,mensions:[],openClose:()=>{a.active?a.close():a.open()},open:()=>{window[Symbol.for("diviDesignNotesAPI")].closeDropdowns(),a.element.classList.add("open"),a.active=!0,a.setPosition()},close:()=>{a.element.classList.remove("open"),a.active=!1},checkMensions(e){a.mensions=[];let t=e;return window[Symbol.for("diviDesignNotesAPI")].data.users.forEach((n=>{e.includes(`@${n.display_name}`)&&(t=t.replace(`@${n.display_name}`,`<span>@${n.display_name}</span>`),!a.mensions.indexOf(n.user_email)+1&&a.mensions.push(n.user_email))})),t},setPosition(){if(!a.active)return;const e=a.marker.element.getBoundingClientRect(),t=e.x<175?1:0,n=innerWidth-e.right<175?3:0,o=innerHeight-e.bottom<200?5:0;let i="";if(o||n||t)switch(o+t+n){case 1:case 4:i=`translateX(${-e.x}px)`;break;case 3:i=`translateX(-${350-(innerWidth-e.right)}px)`;break;case 5:i="translate(-50%,-100%) translate(15px,-40px)";break;case 6:i=`translate(${-e.x}px,-100%) translateY(-40px)`;break;case 8:i=`translate(-${350-(innerWidth-e.right)}px,-100%) translateY(-40px)`;break;case 9:i="translate(0,-100%) translateY(-40px)"}a.element.style.top=`${e.bottom}px`,a.element.style.left=`${e.x}px`,a.element.style.transform=i,a.element.style.maxHeight=o?"":innerHeight-e.bottom+"px"},clear(){a.textArea.value=""},clicked:e=>{e.target.dataset.action&&!a.is_ajaxing&&(a.ajaxing(!0),"cancel"===e.target.dataset.action&&(a.clear(),a.marker.reset(),a.ajaxing(!1)),"create"!==e.target.dataset.action||a.create())},create:()=>{if(!a.textArea.value.trim())return a.textArea.value="",void a.ajaxing(!1);const e=new FormData,t=a.checkMensions(a.textArea.value);a.mensions.length&&e.append("mensions",a.mensions.join(",")),e.append("type","create"),e.append("x",a.marker.position.x),e.append("y",a.marker.position.y),e.append("el",a.marker.getElSelector()),e.append("content",t.trim()),e.append("post_id",window[Symbol.for("diviDesignNotesAPI")].data.post_id),e.append("href",window[Symbol.for("diviDesignNotesAPI")].data.href),e.append("title",window[Symbol.for("diviDesignNotesAPI")].data.title),window[Symbol.for("diviDesignNotesAPI")].ajax(e).then((e=>{if(e.ok)return e.json()})).then((e=>{e.success&&(a.clear(),a.marker.reset(),window[Symbol.for("diviDesignNotesAPI")].createNote(e.html)),a.ajaxing(!1)})).catch((e=>{a.ajaxing(!1)}))},ajaxing(e=null){if(null===e)return a.is_ajaxing;e&&(a.element.classList.add("ajaxing"),a.is_ajaxing=!0),e||(a.element.classList.remove("ajaxing"),a.is_ajaxing=!1)},init(){a.textArea=a.element.querySelector("textarea"),document.body.appendChild(a.element),e("click",a.clicked,a.element)}};return a.init(),a}function r(t){const a={element:t,relatedElement:null,relativeToElement:!1,dropDown:null,active:!1,position:{x:0,y:0},getElSelector:()=>a.relatedElement.id?"#"+a.relatedElement.id:a.relatedElement.classList?"."+Array.from(a.relatedElement.classList).join("."):"#page-container",pinOnPage(e,t){a.position=t,a.relatedElement=e,a.active=!0,a.element.classList.remove("active"),a.getRelativity()?a.setRelPosition():a.setFixPosition(),a.openClose()},setPosition(){a.active&&(a.relativeToElement||a.setFixPosition())},getRelativity:()=>(a.relativeToElement=["relative","absolute","fixed"].includes(getComputedStyle(a.relatedElement).position),a.relativeToElement),setRelPosition(){a.relatedElement.appendChild(a.element),a.element.style.position="absolute",a.element.style.top=a.position.y/a.relatedElement.offsetHeight*100+"%",a.element.style.left=a.position.x/a.relatedElement.offsetWidth*100+"%",a.element.style.transform="translate(-20px,-40px)"},setFixPosition(){const e=a.relatedElement.getBoundingClientRect();a.element.style.transform=`translate3d(${a.position.x+e.x}px,${a.position.y+e.y}px,0)`},openClose(){a.dropDown.openClose()},activate(e){a.element.classList.add("active"),e.appendChild(a.element)},reset(){a.relatedElement=null,a.active=!1,a.dropDown.close(),a.element.style="",a.element.remove()},init:()=>(a.dropDown=s(a,n("#shadowdropdown")),e("click",a.openClose,a.element),a)};return a}function l(a){const o={pageContainer:a,element:n("#divi_design_notes_menu"),moveButton:null,toggleButton:null,move(e){o.element.style.transform=`translate3d(${e.clientX}px,${e.clientY}px,0)`},stopMove(e){t("mousemove",o.move),t("mouseup",o.stopMove),t("mouseleave",o.stopMove,o.element),"mouseleave"===e.type&&(o.element.style.transform="")},clicked(e){if(!e.target.dataset.action)return;const t=e.target.dataset.action;"toggle"===t&&o.element.classList.toggle("open"),"new"===t&&window[Symbol.for("diviDesignNotesAPI")].buttonClicked(e)},input(e){"resolved_notes"===e.target.id&&(e.target.checked?document.body.classList.remove("hide-resolved"):document.body.classList.add("hide-resolved")),"active_notes"===e.target.id&&(e.target.checked?document.body.classList.remove("hide-active"):document.body.classList.add("hide-active"))},init(){o.moveButton=n('span[data-action="move"]'),o.addButton=n('span[data-action="toggle"]'),e("mousedown",(()=>{e("mousemove",o.move),e("mouseup",o.stopMove),e("mouseleave",o.stopMove,o.element)}),o.moveButton),e("click",o.clicked,o.element),e("input",o.input,o.element)}};return o}function d(o,s){const d={button:n("#wp-admin-bar-design_notes"),pageContainer:n("#page-container"),templatesContainer:n("#design_notes_template"),data:JSON.parse(n("#divi_design_notes_json").textContent),notes:[],menu:null,hoveredElement:!1,user:"",markerActive:!1,shadowMarker:null,timeout:0,currenMatch:null,inputTarget:null,caret:null,usersNode:document.createElement("ul"),buttonClicked:e=>(e.preventDefault(),d.markerActive?d.stopMarker():d.startMarker(),d),startMarker(){d.closeDropdowns(),d.shadowMarker.reset(),d.shadowMarker.activate(d.pageContainer),e("mousemove",d.followMarker,d.pageContainer),d.markerActive=!0,document.body.classList.add("marker-active"),e("click",d.markerClicked,d.pageContainer)},stopMarker(){t("mousemove",d.followMarker,d.pageContainer),d.shadowMarker.element.remove(),d.markerActive=!1,document.body.classList.remove("marker-active"),t("click",d.markerClicked,d.pageContainer),d.hoveredElement&&(d.hoveredElement.style.outline="")},followMarker(e){let t=e.target.matches(".et_pb_module")?e.target:e.target.closest(".et_pb_module,.et_pb_row,.et_pb_section,header,#page-container");t?t!==d.hoveredElement&&(d.hoveredElement&&(d.hoveredElement.style.outline=""),d.hoveredElement=t,d.hoveredElement.style.outline="3px solid blue"):d.hoveredElement&&(d.hoveredElement.style.outline="",d.hoveredElement=!1),d.shadowMarker.element.style.transform=`translate3d(${e.clientX}px,${e.clientY}px,0)`},markerClicked(e){e.preventDefault(),t("mousemove",d.followMarker,d.pageContainer),t("click",d.markerClicked,d.pageContainer);const n=d.hoveredElement.getBoundingClientRect(),a={x:e.x-n.x,y:e.y-n.y};d.shadowMarker.pinOnPage(d.hoveredElement,a),d.markerActive=!1,document.body.classList.remove("marker-active"),d.hoveredElement&&(d.hoveredElement.style.outline="")},createNote(e){const t=i(a(e,d.templatesContainer,"afterbegin")).init();d.notes.push(t),t.openClose()},inputHandler(e){if(e.target.matches(".design_note_textarea")){const t=d.inputTarget=e.target,n=t.value.substring(0,t.selectionStart),a=n.match(/@(?<text>[a-z]{0,3})$/i);if(a)if(d.textToCaret=n,d.currenMatch=a,t.parentElement.appendChild(d.usersNode),a.groups.text){const e=d.data.users.filter((e=>e.display_name.toLowerCase().includes(a.groups.text.toLowerCase())));d.usersNode.innerHTML=d.usersListItems(e)}else d.usersNode.innerHTML=d.usersListItems(d.data.users);else d.usersNode.remove()}},closeDropdowns(){d.notes.forEach((e=>{e.dropDown.close()})),d.shadowMarker.dropDown.close()},chooseUser(e){const t=e.target,n=d.inputTarget,a=new RegExp(`${d.currenMatch[0]}$`,"g"),o=d.textToCaret.replace(a,` @${t.dataset.userName} `);n.value=n.value.replace(d.textToCaret,o),n.focus(),n.setSelectionRange(n.value.length+1,n.value.length+1),d.usersNode.remove()},setPositions(){d.notes.forEach((e=>{e.setPosition(),e.dropDown.setPosition()})),d.shadowMarker.setPosition(),d.shadowMarker.dropDown.setPosition()},maybeSetTimeout(e){d.timeout&&clearTimeout(d.timeout),d.timeout=setTimeout((()=>{d.setPositions(),d.timeout=0}),100)},ajax:e=>(e.append("action","divi_design_notes_ajax"),e.append("diviDesignNotesNonce",d.data.nonce),fetch(d.data.ajaxurl,{method:"POST",body:e})),setMarkers(){n("[id^=notemarker]",d.templatesContainer,!0).forEach((e=>{d.notes.push(i(e).init())}))},delete(e){e.dropDown.element.remove(),e.element.remove(),d.notes.splice(d.notes.indexOf(e),1)},usersListItems:e=>html=e.map((e=>`<li data-user-name="${e.display_name}">${e.display_name}<span>${e.user_email}</span></li>`)).join(""),init(){if(d.markerActive&&d.stopMarker(),d.menu)return void(d.notes.length&&d.setPositions());if(!d.pageContainer)return void console.warn("No #page-container element on the page!");d.menu=l(d.pageContainer),d.menu.init(),d.usersNode.id="design_notes_user_list",d.usersNode.innerHTML=d.usersListItems(d.data.users);n("[id^=notemarker]",d.templatesContainer,!0).forEach((e=>{d.notes.push(i(e).init())}));const t=n("#shadowmarker",d.templatesContainer);d.shadowMarker=r(t).init(),e("click",d.chooseUser,d.usersNode),e("scroll",d.maybeSetTimeout),e("resize",d.maybeSetTimeout,window),e("input",d.inputHandler),e("transitionend",d.maybeSetTimeout,d.pageContainer)}};return d}window.addEventListener("load",(function(){const t=n("#wp-admin-bar-design_notes");t&&e("click",(function(){document.body.classList.toggle("show_design_notes"),window[Symbol.for("diviDesignNotesAPI")].init()}),t),window[Symbol.for("diviDesignNotesAPI")]=d()}));
//# sourceMappingURL=main.js.map
